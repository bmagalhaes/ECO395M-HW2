---
title: "homework1"
author: "Bernardo Magalhaes, Adhish Luitel, Ji Heon Shim"
date: "`r format(Sys.Date())`" 
output:
    md_document:
    variant: markdown_github
---
#ECO 395M: Exercise 2

Bernardo Arreal Magalhaes - UTEID ba25727

Adhish Luitel - UTEID al49674

Ji Heon Shim - UTEID js93996

## Exercise 2.2
```{r setup1, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dummies)
library(margins)
library(dplyr)
library(kableExtra)
library(sjPlot)

brca = read.csv(url("https://raw.githubusercontent.com/bmagalhaes/ECO395M-HW2/master/brca.csv"))
```
This exercise is based on a dataset consisted of 987 screening mammograms administered at a hospital in Seattle, Washington. The goal of the analysis is to evaluate the performance of five different radiologists considering several risk factors.

First, we analyzed the raw data to verify whether each radiologist has a different recall rate or not, and compare precision and error rates. We can observe that, even thought radiologist89 has a higher probability of recalling patients, his Type II error rate (not recalling patients that actually have cancer) doesn't substantially differ from radiologist95 and radiologist34, who have the lowest recall rates.

```{r 2.2.1, echo=FALSE}
recall_rate = brca %>%
  group_by(radiologist)  %>%
  summarize(A.recallrate = length(which(recall == 1)) / (length(which(recall == 1))
            + length(which(recall == 0))))

recall_rate = recall_rate[order(-recall_rate$A.recallrate),c(1,2)]
recall_rate = mutate(recall_rate, n = row_number())

cancer_rate = brca %>%
  group_by(radiologist)  %>%
  summarize(B.cancerrate = length(which(recall == 1 & cancer == 1)) / (length(which(recall == 1 & 
            cancer == 1)) + length(which(recall == 1 & cancer == 0))))

error_rate = brca %>%
  group_by(radiologist)  %>%
  summarize(C.error = length(which(recall == 0 & cancer == 1)) / (length(which(recall == 0 & 
            cancer == 1)) + length(which(recall == 0 & cancer == 0))))

radiologist = left_join(recall_rate, cancer_rate, by = "radiologist")
radiologist = left_join(radiologist, error_rate, by = "radiologist")

radiologist_long = radiologist %>%
  gather("Stat", "Value", -radiologist, -n)
radiologist_long = mutate(radiologist_long, Value = Value*100)

radiologist_89 = radiologist_long[which(radiologist_long$n==1), ]

ggplot(data = radiologist_long) + 
  geom_bar(mapping = aes(x=reorder(radiologist, -n), y=Value),
           stat='identity', position ='dodge', fill="lightgray", color="black", alpha=.6, width=.5) + 
  facet_wrap(~Stat) + 
  coord_flip() +
  labs(title="Practice", y="Observed rate (in percentage)", x = "") +
  geom_hline(data= radiologist_89, aes(yintercept=Value), color="red" , linetype = "dashed") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major.y = element_blank(), panel.grid.minor.y = element_blank()) 
```

However, since each radiologist read the mammograms of a different set of patients, this difference could be explained by the fact that some radiologists might have seen patients whose clinical situation required the patient to be recalled for further exams.

In order to analyse if, holding patient risk factors equal, some radiologists are more clinically conservative than others in recalling patients, we built two classification models:

```{r 2.2.2, echo=TRUE}
model1 = recall ~ radiologist + age + history + symptoms + menopause + density
model2 = recall ~ (radiologist + age + history + symptoms + menopause + density)^2
```

The table below shows the Average Marginal Effect (AME) and Average Marginal Effect at xstar (AME at xstar) for each radiologist in the two models. We can see that, for Model 1, radiologist89 is the most conservative - holding patient risk factors equal to a typical patient, the probability of being recalled increases by 7.96 percentage points when radiologist89 is the one reading the mammogram.

(xstar denotes referent values for a typical patient: age 40 to 49,  no history of breast cancer, no symptoms, post-menopausal & hormone-therapy and scattered fibroglandular tissue)
(for Model 1, the standard errors were computed using the Delta method. For Model 2, using bootstrap)


```{r 2.2.3, echo=FALSE}
brca2 = brca
brca2$radiologist = str_replace(brca2$radiologist, "radiologist","")
brca2$age = str_replace(brca2$age, "age","")
brca2$menopause = str_replace(brca2$menopause, "meno","")
brca2$density = str_replace(brca2$density, "density","")

brca_new = dummy.data.frame(brca2, names = c("radiologist", "age","menopause", "density") , sep = ".")
brca_new = subset(brca_new, select = -c(radiologist.13, age.4049,menopause.postHT, density.1))


model_1 = glm(recall ~ . - cancer, data=brca_new, family=binomial)
ame_11 = summary(margins(model_1, variables = list("radiologist.34", "radiologist.66", "radiologist.89", "radiologist.95")))
ame_12 = summary(margins(model_1, at = list(history = 0, symptoms = 0, age.5059 = 0, age.6069 = 0,age.70plus = 0,
                           menopause.pre = 0,menopause.postunknown = 0,menopause.postNoHT = 0,
                           density.2 = 1), variables = list("radiologist.34", "radiologist.66",
                                                            "radiologist.89", "radiologist.95")))

model_2 = glm(recall ~ (. - cancer)^2, data=brca_new, family=binomial)
ame_21 = summary(margins(model_2, variables = list("radiologist.34", "radiologist.66", "radiologist.89", "radiologist.95"), vce = "bootstrap"))
ame_22 = summary(margins(model_2, at = list(history = 0, symptoms = 0, age.5059 = 0, age.6069 = 0,age.70plus = 0,
                           menopause.pre = 0,menopause.postunknown = 0,menopause.postNoHT = 0,
                           density.2 = 1), variables = list("radiologist.34", "radiologist.66",
                                                            "radiologist.89", "radiologist.95"), vce = "bootstrap"))

ame_11 = select(ame_11,-c(4:7))
ame_12 = select(ame_12,-c(2:10,13:16))
ame_21 = select(ame_21,-c(4:7))
ame_22 = select(ame_22,-c(2:10,13:16))

ame = left_join(ame_11, ame_12, by = "factor")
ame = left_join(ame, ame_21, by = "factor")
ame = left_join(ame, ame_22, by = "factor")
colnames(ame) <- c("","AME","se","AME","se","AME","se","AME","se")

kable(ame) %>%
  kable_styling("striped") %>%
  add_header_above(c(" " = 1, "AME" = 2, "AME at x*" = 2, "AME" = 2, "AME at x*" = 2)) %>%
  add_header_above(c(" ", "Model 1" = 4, "Model 2" = 4))
```

